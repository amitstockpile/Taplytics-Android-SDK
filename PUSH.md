Setting up Push Notifications using Taplytics is simple. Follow the steps below to get started.

|#  |Step                                                                       |
|---|---                                                                        |
|1  |  Setup: [Android Studio](#android-studio)           |
|2  | [Receiving Push Notifications](#2-receiving-push-notifications)           |
|3  | [Push Campaigns](#3-push-campaigns)                                       |
|4  | [Retrieving Custom Push Data](#3-retrieving-custom-push-data)             |
|5  | [Setting a Custom Push Intent](#4-setting-custom-push-intent)             |
|6  | [Tracking Push Notification Opens](#5-tracking-push-notification-opens)   |                
|7  | [Resetting Users](#6-resetting-users)                                     |

## 1. Setup

### Android Studio

If you wish to use Push Notifications on Taplytics, you must add the following permissions (replace `com.yourpackagename` with your app's package name) to your Android Manifest:

```xml
<uses-permission android:name="com.google.android.c2dm.permission.RECEIVE" />
<permission android:name="com.yourpackagename.permission.C2D_MESSAGE"/>
<uses-permission android:name="com.yourpackagename.permission.C2D_MESSAGE" />
<uses-permission android:name="android.permission.WAKE_LOCK" />
```
And you must add the following receiver and service under your application tag:

```xml
<receiver
    android:name="com.taplytics.sdk.TLGcmBroadcastReceiver"
    android:permission="com.google.android.c2dm.permission.SEND" >
    <intent-filter>
        <action android:name="com.google.android.c2dm.intent.RECEIVE" />
    </intent-filter>
</receiver>
<service android:name="com.taplytics.sdk.TLGcmIntentService" />
```

In order to set the notification icon you must add a meta-tag to your manifest specifying the drawable you want to use as the icon:

```xml
<meta-data android:name="com.taplytics.sdk.notification_icon"
            android:resource="@drawable/notification_icon"/>
```

If this isn't set the application's icon will be used instead.

---

## 2. Receiving Push Notifications

To send your users Push Notifications, we'll need you to upload your Google Cloud Messaging credentials. Please follow [this guide](https://taplytics.com/docs/guides/push-notifications/google-push-certificates) to do so.

### Activity Routing

By default, when a notification sent by Taplytics is clicked, it will open up the main activity of the application. However, you may want to route your users to a different Activity. This can be done on the Taplytics Push page.

Simply add a custom data value to the push with the key `tl_activity` and with the **full** (_including package name_) class name of your activity. For example:


![image](https://s3.amazonaws.com/cdn.taplytics.com/Images/push_custom_data.png)

### Push Title

By default, the title of a push notification will be the application name. 

Currently, the best way to change the title of a push notification is to add a `tl_title` custom key. For Example:

![image](https://s3.amazonaws.com/cdn.taplytics.com/Images/push_custom_data_2.png)

### Getting the Push Token
Sometimes, it can be useful to have the actual token generated by GCM, to target pushes at specific users.

To get this token, use the following method:

```java
        Taplytics.setTaplyticsPushTokenListener(new TaplyticsPushTokenListener() {
            @Override
            public void pushTokenReceived(String token) {
             //Do something with the push token here.
            }
        });
```

---


## 3. Push Campaigns

Push Campaigns allow you to send pushes in reaction to events, called triggers. Location based triggers use the Google Play Services Location API in order to create geofences for the locations you specify.

For location based triggers add the following two permissions to you manifest:

```xml 
<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/>
<uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED"/>
``` 

The `ACCESS_FINE_LOCATION` permission is used to get the devices location, and the `RECEIVE_BOOT_COMPLETED` permission is to re-register the locations which the campaign is triggered in, which get cleared upon reboot.


Also needed is a boot receiver to re-register events, and an intent service to react to geofence events. Both which go in your manifest, under the application tag:

```xml
<receiver android:name="com.taplytics.sdk.TLBootReceiver">
	<intent-filter>
		<action android:name="android.intent.action.BOOT_COMPLETED"/>
	</intent-filter>
</receiver>

<service android:name="com.taplytics.sdk.TLGeofenceEventService"/>
```

The only additional dependency needed is Google Play Services Location API, which you can add to your module's  `build.gradle` file under dependencies:

`compile 'com.google.android.gms:play-services-location:8.1.0'`

## 4. Retrieving Custom Push Data

On the push dashboard, custom data can be entered into push notifications. To receive this data, you can use a PushNotificationListener. 

```java
Taplytics.addPushNotificationListener(new TaplyticsPushNotificationListener() {
            @Override
            public void pushReceived(JSONObject customData) throws JSONException {
                //There it is!
            }
        });
```

You can add as many PushNotificationListeners in your application as you would like. To remove them, simply save a reference to the PushNotificationListener and call `Taplytics.removePushNotificationListener`. '`

## 5. Setting Custom Push Intent

To further customize the push notification intent, a ```PushNotificationIntentListener``` can be used to supply an entirely new intent to be used by the push notification. This listener is triggered when a push notification is being built, so the custom data from the Taplytics dashboard can be used in the new intent if needed.  

```java
Taplytics.setPushNotificationIntentListener(new TaplyticsPushNotificationIntentListener() {
            @Override
            public Intent setPushNotificationIntent(JSONObject customData) throws JSONException {
               //return your own custom intent (CustomData is the custom keys from the dashboard)
            }
        });                
```

## 6. Tracking Push Notification Opens

By default, Taplytics will automatically track push notification opens. However, if this information is needed elsewhere, a `TaplyticsPushOpenedListener` can be used to track a push being opened.


```java
        Taplytics.setPushNotificationOpenedListener(new TaplyticsPushOpenedListener() {
            @Override
            public void pushOpened(Bundle bundle) {
                //The push has been opened. Bundle is the extras associated with the intent. 
            }
        });
```

Note: If the push notification is opened while currently on the page that the push notification opens, it will not be tracked. Also, if the push notification doesn't open an activity, or if it opens an application other than the one building the notification, this cannot be tracked. 


## 7. Resetting Users

Sometimes, it may be useful to reset an app user for push notifications. For instance, if a user is logged out in your app, you may want them to stop receiving push notifications. If you wish to turn off push notifications for an app user, it can be done as such:

```java
TaplyticsResetUserListener listener = new TaplyticsResetUserListener() {
  @Override
  public void finishedResettingUser() {
    // Do stuff
  }
};

Taplytics.resetAppUser(listener);
```

Now, the device that the app is currently running on will no longer receive push notifications until the app user attributes are updated again.


